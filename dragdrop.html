<html>
  <head>
    <base href="https://rawgithub.com/terwey/ng-aloha-editor/master/">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.6/angular.js"></script>

    <script src="libs/alohaeditor-0.23.26/aloha/lib/require.js"></script>
    <script src="libs/alohaeditor-0.23.26/aloha/lib/vendor/jquery-1.7.2.js"></script>
    <script type="text/javascript">
        var Aloha = window.Aloha || ( window.Aloha = {} );

        Aloha.settings = {
            plugins: {
                load: "common/ui, common/format, common/paste, common/block, common/list, common/table, extra/draganddropfiles, common/image"
            }
        }

        var globalElementSave;
        var globalJsonSave;
    </script>
    <style type="text/css">
    .dropZone {
        margin: 1em;
        border: 3px dashed lightgray;
        height: 1.5em;
        width: 100%;
    }

    .imageBlock {
        margin: 1em;
        padding: 1em;
        border: 1px solid gray;
        background-color: lightgray;
    }

    .draggy {
        border:1px dotted black;
        display: inline-block;
        padding: 1em;
        margin: 0.5em;
        float: left;
    }

    .clear {
        clear: both;
    }
    </style>
    <script type="text/javascript">
    /* 
    make all the make draggable
    */

    jQuery.fn.makeDraggable = function() {
        jQuery(this).bind('dragstart', function(e) {
            var target = e.target || e.srcElement;
            var data = JSON.stringify(jQuery(target).data());
            e.originalEvent.dataTransfer.setData('Text', data);
        });

        jQuery(this).bind('touchstart', function(e) {
            e.originalEvent.preventDefault();
            var target = e.target || e.srcElement;

            jQuery(target).bind('touchmove', function(e) {
                event = e.originalEvent;
                if (event.targetTouches.length == 1) {
                    var touch = event.targetTouches[0];
                    
                    if (jQuery('#draghandle').length == 0) {
                        var draghandle = jQuery(touch.target).clone(false);
                        draghandle.prop('id','draghandle');
                        jQuery('body').prepend(draghandle);
                    } else {
                        var draghandle = jQuery('#draghandle');
                    }
                    
                    // Place element where the finger is
                    $(draghandle).css('position', 'absolute');
                    $(draghandle).css('left', touch.pageX + 'px');
                    $(draghandle).css('top', touch.pageY + 'px');

                    var elementFromPoint = document.elementFromPoint(touch.pageX-2, touch.pageY-2);
                    if (jQuery(elementFromPoint).parents().is('.aloha-editable')) {
                        globalElementSave = elementFromPoint;
                        globalJsonSave = jQuery(touch.target).data();
                        var jE = jQuery(globalElementSave);

                        var dropZone = jQuery('<div class="dropZone"></div>');
                        if (!jE.next().hasClass('dropZone')) {
                            jQuery('.dropZone').remove();
                            jE.after(dropZone);
                        }
                    }
                }
            });
        });

        jQuery(this).bind('touchend', function(e) {
            jQuery('#draghandle').remove();
            jQuery('.dropZone').remove();
            event = e.originalEvent;
            var jE = jQuery(globalElementSave);
            var json = globalJsonSave;
            var block = jQuery('<div class="imageBlock">Type: <strong>'+json.alohablock+'</strong><br />ID: <strong>'+json.imageid+'</strong></div>');
            Aloha.jQuery(block).alohaBlock();
            jE.after(block);
            globalElementSave = undefined;
        });
    }

    jQuery( document ).ready(function() {
        jQuery("[draggable='true']").makeDraggable();

        /*
        First bind the Events
        */
        Aloha.ready(function () {
            jQuery('.aloha-editable').on("dragover", 'p', function(jQueryEvent) {
                var dropZone = jQuery('<div class="dropZone"></div>');
                if (!jQuery(jQueryEvent.target).next().hasClass('dropZone')) {
                    jQuery(jQueryEvent.target).after(dropZone);
                }
            });

            jQuery('.aloha-editable').on("dragleave", 'p', function(jQueryEvent) {
                if (jQuery(jQueryEvent.target).next().hasClass('dropZone')) {
                    jQuery('.dropZone').remove();
                }
            });

            jQuery('.aloha-editable').on("drop", 'p', function(jQueryEvent) {
                jQueryEvent.originalEvent.preventDefault();
                
                if (jQuery(jQueryEvent.target).next().hasClass('dropZone')) {
                    jQuery('.dropZone').remove();
                }
                
                var json = jQuery.parseJSON(jQueryEvent.originalEvent.dataTransfer.getData('Text'));
                var block = jQuery('<div class="imageBlock">Type: <strong>'+json.alohablock+'</strong><br />ID: <strong>'+json.imageid+'</strong></div>');
                Aloha.jQuery(block).alohaBlock();
                jQuery(jQueryEvent.target).after(block);
            });
        });
    });
    </script>
    <script src="libs/alohaeditor-0.23.26/aloha/lib/aloha.js"></script>
    <script src="ng-aloha-editor.js"></script>
    <script>
    angular.module('ExamplePage', ['ngAlohaEditor']);
    </script>
    <script>
    var ngAlohaEditorConfig = { baseUrl: '' };
    </script>
    <link href="libs/alohaeditor-0.23.26/aloha/css/aloha.css" rel="stylesheet" type="text/css" />
  </head>
  <body ng-app="ExamplePage">
    <div id="dragholder">
        <div data-ng-repeat="i in [1,2,3,4,5,6,7,8,9,10]" draggable="true" class="draggy" data-alohaBlock="image" data-imageId="{{$index}}">DRAG ME! Image {{$index}}</div>
    </div>
    
    <hr />
    <div class="clear" ng-init="examples=[{ name: 'one', content:'<p>Foo bar baz 1</p><p>Foo bar baz 2</p><p>Foo bar baz 3</p><p>Foo bar baz 4</p>' }, { name: 'two', content:'<p>herp derp</p>'}]">
      <div style="min-height: 100px; border: 1px inset; margin: 1em;"
        ng-repeat="ex in examples"
        ng-class="example-{{ex.name}}"
        data-aloha-content='{{ex.content}}'
        aloha>
      </div>
    </div>
  </body>
</html>